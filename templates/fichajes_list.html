{% extends "base.html" %}

{% block title %}Historial de Fichajes{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fichajes.css') }}">
{% endblock %}

{% block content %}
<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title-box">
            <i class="ph-bold ph-clock-user"></i> Control de Presencia
        </h2>
        
        <div class="d-flex gap-3 align-items-center">
            
            <form action="{{ url_for('rrhh_web.ejecutar_notificaciones_ausencia') }}" method="POST" onsubmit="return confirm('¿Lanzar comprobación de ausencias?\nSe enviarán correos a quien no haya fichado hoy.');">
                <button type="submit" class="btn btn-pop-warning" title="Enviar alertas por no fichar">
                    <i class="ph-bold ph-bell-ringing me-2"></i> VERIFICAR AUSENCIAS
                </button>
            </form>

            <a href="{{ url_for('rrhh_web.fichaje_nuevo') }}" class="btn btn-pop btn-pop-primary d-none d-md-inline-block">
                <i class="ph-bold ph-plus me-2"></i> NUEVO FICHAJE
            </a>
        </div>
    </div>

    {% if resumen %}
    <div class="summary-card mb-4">
        <div class="summary-badge">
            <i class="ph-bold ph-calendar-check"></i> PERIODO: {{ resumen.rango }}
        </div>
        
        <div class="row g-4 align-items-center mt-2 justify-content-center">
            
            <div class="col-md-5">
                <div class="stat-box" style="background-color: #fff;">
                    <span class="stat-number">{{ resumen.trabajadas }}h</span>
                    <span class="stat-label">Total Horas Trabajadas</span>
                </div>
            </div>

            <div class="col-md-5">
                {% if resumen.saldo >= 0 %}
                    <div class="stat-box bg-green-pop">
                        <span class="stat-number">+{{ resumen.saldo }}h</span>
                        <span class="stat-label"><i class="ph-bold ph-trend-up"></i> HORAS EXTRAS</span>
                    </div>
                {% else %}
                    <div class="stat-box bg-red-pop">
                        <span class="stat-number">{{ resumen.saldo }}h</span>
                        <span class="stat-label"><i class="ph-bold ph-trend-down"></i> HORAS PENDIENTES</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card card-pop mb-4" style="background-color: #fff;">
        <div class="card-body p-4">
            <form method="GET" action="{{ url_for('rrhh_web.fichajes_list') }}" class="row g-3 align-items-end">
                
                <div class="col-md-4">
                    <label class="fw-black small text-uppercase mb-2"><i class="ph-bold ph-user"></i> Empleado</label>
                    <select name="empleado_id" class="form-select filter-input-orange" onchange="this.form.submit()">
                        <option value="">-- Seleccionar para ver Resumen --</option>
                        {% for emp in empleados %}
                            <option value="{{ emp.id_trabajador }}" {% if filtro_empleado == emp.id_trabajador %}selected{% endif %}>
                                {{ emp.nombre }} {{ emp.apellidos }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="fw-black small text-uppercase mb-2">Desde</label>
                    <input type="date" name="fecha_desde" class="form-control filter-input-blue" value="{{ filtro_desde if filtro_desde else '' }}">
                </div>

                <div class="col-md-2">
                    <label class="fw-black small text-uppercase mb-2">Hasta</label>
                    <input type="date" name="fecha_hasta" class="form-control filter-input-blue" value="{{ filtro_hasta if filtro_hasta else '' }}">
                </div>

                <div class="col-md-4 d-flex gap-2">
                    <button type="submit" class="btn btn-filter-action w-100 py-2">
                        <i class="ph-bold ph-magnifying-glass"></i> FILTRAR
                    </button>
                    
                    {% if filtro_empleado or filtro_desde or filtro_hasta %}
                        <a href="{{ url_for('rrhh_web.fichajes_list') }}" class="btn btn-outline-dark border-3 border-dark fw-bold" title="Limpiar filtros" style="box-shadow: 4px 4px 0px #000;">
                            <i class="ph-bold ph-broom fs-4"></i>
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    {% if not jornadas %}
        <div class="alert alert-light border-3 border-dark p-5 text-center">
            <i class="ph-duotone ph-ghost fs-1 mb-3"></i>
            <h4 class="fw-bold">No se encontraron registros</h4>
            <p>Intenta cambiar los filtros de búsqueda.</p>
        </div>
    {% else %}
        <div class="card card-pop">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead style="background-color: #ffde59; border-bottom: 4px solid #000;">
                            <tr>
                                <th class="py-3 ps-4 text-uppercase">Empleado</th>
                                <th class="py-3 text-uppercase text-center">Jornada</th>
                                <th class="py-3 text-uppercase text-center">Duración</th>
                                <th class="py-3 text-uppercase text-center">Estado</th>
                                <th class="py-3 text-uppercase text-center">Mapa</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for j in jornadas %}
                            <tr class="shift-row" style="border-bottom: 2px solid #000;">
                                
                                <td class="ps-4">
                                    <div class="d-flex flex-column">
                                        <span class="fw-bold">{{ j.trabajador.nombre }} {{ j.trabajador.apellidos }}</span>
                                        <span class="small text-muted font-monospace">{{ j.trabajador.nif }}</span>
                                    </div>
                                </td>

                                <td>
                                    <div class="d-flex align-items-center justify-content-center gap-3">
                                        
                                        {% if j.entrada %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="time-badge time-badge-entry">
                                                    {{ j.entrada.fecha_hora.strftime('%H:%M') }}
                                                </span>
                                                <small class="text-muted fw-bold mt-1" style="font-size: 0.7rem;">
                                                    {{ j.entrada.fecha_hora.strftime('%d/%m') }}
                                                </small>
                                                <form action="{{ url_for('rrhh_web.fichaje_delete', fichaje_id=j.entrada.id_fichaje) }}" method="POST" onsubmit="return confirm('¿Borrar esta entrada?');" class="mt-1">
                                                    <button type="submit" class="btn btn-link p-0 text-danger" title="Eliminar entrada">
                                                        <i class="ph-bold ph-trash fs-5"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        {% else %}
                                            <div class="time-badge bg-danger text-white border-dark">???</div>
                                        {% endif %}

                                        <i class="ph-bold ph-arrow-right timeline-arrow"></i>

                                        {% if j.salida %}
                                            <div class="d-flex flex-column align-items-center">
                                                <span class="time-badge time-badge-exit">
                                                    {{ j.salida.fecha_hora.strftime('%H:%M') }}
                                                </span>
                                                <small class="text-muted fw-bold mt-1" style="font-size: 0.7rem;">
                                                    {{ j.salida.fecha_hora.strftime('%d/%m') }}
                                                </small>
                                                <form action="{{ url_for('rrhh_web.fichaje_delete', fichaje_id=j.salida.id_fichaje) }}" method="POST" onsubmit="return confirm('¿Borrar esta salida?');" class="mt-1">
                                                    <button type="submit" class="btn btn-link p-0 text-danger" title="Eliminar salida">
                                                        <i class="ph-bold ph-trash fs-5"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        {% elif j.status == 'active' %}
                                            <span class="badge bg-success border border-dark text-white p-2">
                                                <i class="ph-bold ph-spinner animate-spin me-1"></i> EN CURSO
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger border border-dark text-white p-2">
                                                <i class="ph-bold ph-warning me-1"></i> SIN CIERRE
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>

                                <td class="text-center fw-bold font-monospace fs-5">
                                    {{ j.duracion }}
                                </td>

                                <td class="text-center">
                                    <div class="status-dot {{ j.status }}" title="Estado: {{ j.status }}"></div>
                                </td>

                                <td class="text-center">
                                    {% if j.entrada %}
                                        <a href="http://maps.google.com/maps?q={{ j.entrada.latitud }},{{ j.entrada.longitud }}" 
                                           target="_blank" class="btn btn-sm btn-link text-dark border-2 border-dark"
                                           style="background-color: #ffde59; box-shadow: 2px 2px 0px #000; text-decoration: none;">
                                            <i class="ph-bold ph-map-trifold fs-5"></i>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
    
    <a href="{{ url_for('rrhh_web.fichaje_nuevo') }}" class="btn btn-pop btn-pop-primary d-md-none position-fixed bottom-0 end-0 m-4 shadow-lg" style="z-index: 1000; border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
        <i class="ph-bold ph-plus fs-3"></i>
    </a>
</div>
{% endblock %}